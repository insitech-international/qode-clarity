name: Deploy Frontend & Extract Categories

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: "20"
  PYTHON_VERSION: "3.11"
  WORKING_DIRECTORY: "./frontend"
  BACKEND_DIRECTORY: "./backend"
  PUBLIC_URL: ${{ secrets.PUBLIC_URL }}
  REACT_APP_API_URL: ${{ secrets.API_URL }}
  REACT_APP_STATIC_URL: ${{ secrets.STATIC_URL }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
      deployments: write

    steps:
      # GitHub CLI and Deployment Management
      - name: Install GitHub CLI
        run: sudo apt-get install -y gh

      - name: Authenticate GitHub CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Cancel In-Progress Deployments
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking for in-progress deployments..."
          deployments=$(gh api \
            repos/insitech-international/code-clarity/deployments \
            --jq '.[] | select(.environment == "github-pages" and .state == "in_progress") | .id' \
            2>/dev/null || echo "")

          if [ -z "$deployments" ]; then
            echo "No in-progress deployments found"
            exit 0
          fi

          for deployment in $deployments; do
            echo "Canceling deployment $deployment..."
            gh api \
              -X POST \
              repos/insitech-international/code-clarity/deployments/$deployment/statuses \
              -f state="inactive" \
              --silent || echo "Failed to cancel deployment $deployment"
          done

      # Repository and Environment Setup
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: ${{ env.WORKING_DIRECTORY }}/package-lock.json

      # Backend Environment and API Setup
      - name: Setup Backend Environment
        run: |
          python -m pip install --upgrade pip
          pip install -r ${{ env.BACKEND_DIRECTORY }}/requirements.txt

      - name: Start FastAPI Server
        run: |
          uvicorn backend.code_clarity_fastapi.main:app --host 0.0.0.0 --port 8000 &
          timeout 10s bash -c 'until curl -s http://127.0.0.1:8000/questions/; do sleep 1; done' || exit 1

      # Frontend Environment Preparation
      - name: Prepare Frontend Environment
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          cat > .env << EOF
          REACT_APP_API_URL=${{ env.REACT_APP_API_URL }}
          REACT_APP_STATIC_URL=${{ env.REACT_APP_STATIC_URL }}
          PUBLIC_URL=${{ env.PUBLIC_URL }}
          NODE_ENV=production
          EOF

          cat .env

      # Data Directory Population
      - name: Create and Populate Data Directories
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          mkdir -p public/static/data/{questions,solutions}

          echo "Copying question bank..."
          if ! cp -r ../backend/code_clarity_fastapi/data/question_bank/* public/static/data/questions/; then
            echo "Error copying question bank"
            exit 1
          fi

          echo "Copying solution bank..."
          if ! cp -r ../backend/code_clarity_fastapi/data/solution_bank/* public/static/data/solutions/; then
            echo "Error copying solution bank"
            exit 1
          fi

          # Generate directory listings
          find public/static/data/questions -type d | while read dir; do
            (cd "$dir" && ls -1 > directory_listing.txt)
          done

          find public/static/data/solutions -type d | while read dir; do
            (cd "$dir" && ls -1 > directory_listing.txt)
          done

          echo "Verifying directory structure..."
          find public/static/data -type d
          echo "Verifying file counts..."
          echo "Questions: $(find public/static/data/questions -type f -name "*.md" | wc -l)"
          echo "Solutions: $(find public/static/data/solutions -type f -name "*.md" | wc -l)"

      # Index and Category Generation
      - name: Generate Index Files
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          mkdir -p scripts

          cat > scripts/generateIndex.js << 'EOF'
          const fs = require('fs');
          const path = require('path');

          function walkDir(dir) {
            let results = [];
            const list = fs.readdirSync(dir);

            list.forEach((file) => {
              const filePath = path.join(dir, file);
              const stat = fs.statSync(filePath);

              if (stat && stat.isDirectory()) {
                results = results.concat(walkDir(filePath));
              } else if (path.extname(file) === '.md') {
                const id = file.split('_')[0];
                results.push({
                  id: parseInt(id),
                  path: filePath.replace(/^.*\/public\/static\/data\//, 'static/data/')
                });
              }
            });

            return results;
          }

          function generateIndex() {
            const questionsDir = path.join(process.cwd(), 'public/static/data/questions');
            const solutionsDir = path.join(process.cwd(), 'public/static/data/solutions');

            const index = {
              questions: walkDir(questionsDir),
              solutions: walkDir(solutionsDir)
            };

            fs.writeFileSync(
              path.join(process.cwd(), 'public/static/data/index.json'),
              JSON.stringify(index, null, 2)
            );
          }

          generateIndex();
          EOF

          node scripts/generateIndex.js

          echo "Checking generated files..."
          ls -l public/static/data/index.json

      - name: Extract Categories and Subcategories
        working-directory: ${{ env.WORKING_DIRECTORY }}
        env:
          DEV_API_URL: ${{ secrets.API_URL }}
        run: |
          mkdir -p public/static/data

          python3 - << EOF
          import json
          import requests
          import os
          import sys

          def extract_categories(questions):
              categories = {}
              for question in questions:
                  category = question.get('category', '')
                  subcategory = question.get('subcategory', '')
                  
                  if category:
                      categories.setdefault(category, set()).add(subcategory or 'Uncategorized')

              return {
                  cat: sorted(list(subs)) 
                  for cat, subs in categories.items()
              }

          try:
              api_url = os.environ.get('DEV_API_URL', 'http://127.0.0.1:8000/questions/')
              response = requests.get(api_url, timeout=10)
              response.raise_for_status()
              
              questions = response.json()
              categories_dict = extract_categories(questions)

              with open('public/static/data/categories.json', 'w') as f:
                  json.dump(categories_dict, f, indent=2)

              print("Categories extracted and saved to public/static/data/categories.json")
              print("Categories found:", list(categories_dict.keys()))
          except Exception as e:
              print(f"Error extracting categories: {e}")
              sys.exit(1)
          EOF

          ls -l public/static/data/categories.json
          cat public/static/data/categories.json

      # Frontend Dependencies and Build
      - name: Install Frontend Dependencies
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          rm -rf node_modules package-lock.json

          npm install --no-package-lock
          npm install --save \
            react-icons@4.12.0 \
            gh-pages@6.1.1 \
            axios@1.6.7 \
            fs-extra@11.2.0
          npm install --save-dev @babel/plugin-proposal-private-property-in-object@7.21.11

          npm list --depth=0

      - name: Setup Frontend Base Environment
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          cat > .env << EOF
          REACT_APP_BASE_URL=${{ env.PUBLIC_URL }}
          PUBLIC_URL=${{ env.PUBLIC_URL }}
          EOF

          cat .env

      - name: Build Frontend Application
        working-directory: ${{ env.WORKING_DIRECTORY }}
        env:
          CI: false
        run: |
          npm run build

          if [ ! -d "build" ]; then
            echo "Build directory not created!"
            exit 1
          fi
          echo "Build size: $(du -sh build)"

      # Deployment Preparation
      - name: Prepare Deployment Artifacts
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          cd build
          echo "${{ env.PUBLIC_URL }}" | sed 's/https:\/\///' > CNAME
          touch .nojekyll
          cp index.html 404.html

          ls -la
          cat CNAME

      # GitHub Pages Deployment
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./frontend/build
          force_orphan: true
          user_name: "github-actions[bot]"
          user_email: "github-actions[bot]@users.noreply.github.com"
          commit_message: "Deploy to GitHub Pages [skip ci]"
          full_commit_message: |
            Deploy to GitHub Pages

            Deployed from commit: ${{ github.sha }}
            Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      # GitHub Pages Configuration
      - name: Configure GitHub Pages
        uses: actions/configure-pages@v4
        with:
          enablement: true

      # Deployment Verification
      - name: Verify Deployment Branch
        run: |
          MAX_ATTEMPTS=10
          ATTEMPT=1

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Checking gh-pages branch (attempt $ATTEMPT/$MAX_ATTEMPTS)..."
            if git ls-remote --heads origin gh-pages > /dev/null; then
              echo "âœ“ gh-pages branch exists and is ready"
              exit 0
            fi
            ATTEMPT=$((ATTEMPT + 1))
            sleep 10
          done

          echo "Error: gh-pages branch was not created after $MAX_ATTEMPTS attempts"
          exit 1